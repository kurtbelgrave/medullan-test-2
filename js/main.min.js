/*
 * Javascript 2048 implementation.
 * (c) 2014 Kofi Doku Atuah.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
 * MA 02110-1301, USA.
 *
 */

define("2048",[],function(){function r(n,r,i){this.nEmpty=e,this.targetMaxNum=r,this.newNumVal=i,this.grid=n,this.squares=[t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t]}var e=16,t=0,n={};return n.newBoard=function(e,t,n){return new r(e,t,n)},n.getMaxNSquares=function(){return e},r.prototype.getTargetMaxNum=function(){return this.targetMaxNum},r.prototype.getNewNumVal=function(){return this.newNumVal},r.prototype.reset=function(){var n;for(n=0;n<e;n++)this.squares[n]=t;this.nEmpty=e,this.spawnNewNumber(),this.spawnNewNumber()},r.prototype.spawnNewNumber=function(){var n,r;if(this.nEmpty===0)return;n=Math.random()*100%this.nEmpty,n=Math.floor(n);for(r=0;r<e;r++)this.squares[r]==t&&n--===0&&(this.squares[r]=this.newNumVal,this.nEmpty--)},r.prototype.collapseRow=function(e,n){var r,i,s=0,o;r=e;for(o=0;o<3;o++,r+=n){if(this.squares[r]==t)continue;i=r+n,this.squares[r]==this.squares[i]&&(this.squares[r]*=2,this.squares[i]=t,this.nEmpty++,s=1)}return s},r.prototype.collapseDown=function(){var e,t=0;for(e=12;e<16;e++)t+=this.collapseRow(e,-4);return t},r.prototype.collapseUp=function(){var e,t=0;for(e=0;e<4;e++)t+=this.collapseRow(e,4);return t},r.prototype.collapseRight=function(){var e,t=0;for(e=3;e<16;e+=4)t+=this.collapseRow(e,-1);return t},r.prototype.collapseLeft=function(){var e,t=0;for(e=0;e<16;e+=4)t+=this.collapseRow(e,1);return t},r.prototype.shiftRow=function(e,n){var r,i,s=0,o;r=e;for(o=0;o<3;o++,r+=n){if(this.squares[r]!=t)continue;i=r+n;if(this.squares[i]==t)continue;this.squares[r]=this.squares[i],this.squares[i]=t,s=1}return s},r.prototype.shiftDown=function(){var e,t=0;for(e=12;e<16;e++)while(this.shiftRow(e,-4))t++;return t},r.prototype.shiftUp=function(){var e,t=0;for(e=0;e<4;e++)while(this.shiftRow(e,4))t++;return t},r.prototype.shiftRight=function(){var e,t=0;for(e=3;e<16;e+=4)while(this.shiftRow(e,-1))t++;return t},r.prototype.shiftLeft=function(){var e,t=0;for(e=0;e<16;e+=4)while(this.shiftRow(e,1))t++;return t},r.prototype.draw=function(){function i(e){var n,r=[{num:2,colour:"grey"},{num:4,colour:"brown"},{num:8,colour:"teal"},{num:16,colour:"red"},{num:32,colour:"pink"},{num:64,colour:"purple"},{num:128,colour:"blue"},{num:256,colour:"green"},{num:512,colour:"white"},{num:1024,colour:"yellow"},{num:2048,colour:"gold"}];if(e==t)return"";for(n=0;n<r.length;n++)if(r[n].num==e)return r[n].colour;return""}var e,n,r;n=this.grid.getElementsByTagName("div");for(r=0,e=0;r<16;r++,e++)n[r].style.backgroundColor=i(this.squares[e]),n[r].innerHTML='<span class="cell-number">'+(this.squares[e]===0?"":this.squares[e])+"</span>"},r.prototype.moveDown=function(){var e,t;return e=this.shiftDown(),t=this.collapseDown(),e+=this.shiftDown(),(e||t)&&this.spawnNewNumber(),e+t},r.prototype.moveUp=function(){var e,t;return e=this.shiftUp(),t=this.collapseUp(),e+=this.shiftUp(),(e||t)&&this.spawnNewNumber(),e+t},r.prototype.moveLeft=function(){var e,t;return e=this.shiftLeft(),t=this.collapseLeft(),e+=this.shiftLeft(),(e||t)&&this.spawnNewNumber(),e+t},r.prototype.moveRight=function(){var e,t;return e=this.shiftRight(),t=this.collapseRight(),e+=this.shiftRight(),(e||t)&&this.spawnNewNumber(),e+t},n}),define("tic-tac-toe",[],function(){function f(t,r){var i;this.grid=t,this.gridElementTagName=r,this.currentPlan=null,this.currentPlayer=e,this.haveCenterSquare=0,this.haveTopSquare=0,this.haveRightSquare=0,this.haveBottomSquare=0,this.haveLeftSquare=0,this.squares=[n,n,n,n,n,n,n,n,n],this.nEmpty=this.squares.length}var e="X",t="O",n="",r=4,i=1,s=5,o=7,u=3,a={};return a.lossPlan=[t,t,t,t,t,t,t,t,t],a.plans=[[t,t,t,n,n,n,n,n,n],[n,n,n,t,t,t,n,n,n],[n,n,n,n,n,n,t,t,t],[t,n,n,t,n,n,t,n,n],[n,t,n,n,t,n,n,t,n],[n,n,t,n,n,t,n,n,t],[t,n,n,n,t,n,n,n,t],[n,n,t,n,t,n,t,n,n]],a.newTicTacToeBoard=function(e){return new f(e)},a.centerSquareSet=function(e){return e[r]!=n},a.topSquareSet=function(e){return e[i]!=n},a.rightSquareSet=function(e){return e[s]!=n},a.bottomSquareSet=function(e){return e[o]!=n},a.leftSquareSet=function(e){return e[u]!=n},a.edgeSquareSet=function(e){return this.topSquareSet(e)||this.rightSquareSet(e)||this.bottomSquareSet(e)||this.leftSquareSet(e)},f.prototype.reset=function(e,r){var i;this.currentPlan=null,this.haveCenterSquare=this.haveTopSquare=this.haveRightSquare=this.haveBottomSquare=this.haveLeftSquare=0;switch(e){case"easy":this.difficulty="easy";break;case"hard":this.difficulty="hard";break;default:this.difficulty="normal"}switch(r){case"two-player":case"twoplayer":case"2-player":case"2player":case"multiplayer":this.mode="two-player";break;default:this.mode="single-player"}this.nEmpty=this.squares.length;for(i=0;i<this.squares.length;i++)this.squares[i]=n;this.selectFirstPlayer(),mode=="single-player"&&(this.selectInitialPlan(),this.currentPlayer==t&&(this.aiPlay(),this.changePlayer()))},f.prototype.selectFirstPlayer=function(){var t;t=Math.floor(Math.random()*10),t%=2,this.currentPlayer=t===0?e:MARK_Y},f.prototype.setSquare=function(e,t){this.squares[e]=t,this.nEmpty--},f.prototype.selectInitialPlan=function(){var e;for(;;){e=Math.floor(Math.random()*100),e%=a.plans.length;if(this.getPlanViability(a.plans[e])>0){this.currentPlan=a.plans[e],console.log("Selected initial plan "+e);return}}},f.prototype.selectNewPlan=function(){var e,t,n,r,i;r=0,e=0;for(i=0;i<a.plans.length;i++){t=this.getPlanViability(a.plans[i]);if(t===0)continue;t>e&&(e=t,n=a.plans[i],r=i)}e===0?(n=a.lossPlan,console.log("Selected loss plan")):console.log("Selected new plan "+r+" with viability "+e),this.currentPlan=n},f.prototype.getPlanViability=function(r){var i,s=0;a.centerSquareSet(r)&&(s+=2),a.edgeSquareSet(r)&&s++;for(i=0;i<this.squares.length;i++){if(r[i]==n)continue;if(this.squares[i]==e)return 0;this.squares[i]==t&&s++,s++}return s},f.prototype.aiPlay=function(){var e,t,n;this.getPlanViability(this.currentPlan)===0&&this.selectNewPlan(),this.aiExecuteNextStep()},f.prototype.aiExecuteNextStep=function(){var e;if(this.difficulty=="hard"&&a.centerSquareSet(this.currentPlan)&&!a.centerSquareSet(this.squares)){this.setSquare(r,t);return}if(this.difficulty=="normal"&&a.edgeSquareSet(this.currentPlan)){var f,l,c,h;f=a.topSquareSet(this.currentPlan),l=a.bottomSquareSet(this.currentPlan),c=a.leftSquareSet(this.currentPlan),h=a.rightSquareSet(this.currentPlan);if(f&&!a.topSquareSet(this.squares)){this.setSquare(i,t);return}if(l&&!a.bottomSquareSet(this.squares)){this.setSquare(o,t);return}if(c&&!a.leftSquareSet(this.squares)){this.setSquare(u,t);return}if(h&&!a.rightSquareSet(this.squares)){this.setSquare(s,t);return}}for(e=0;e<this.squares.length;e++){if(this.currentPlan[e]==n)continue;if(this.squares[e]!=n)continue;this.setSquare(e,t)}},f.prototype.userPlay=function(e){this.setSquare(e,this.currentPlayer)},f.prototype.changePlayer=function(){this.currentPlayer=this.currentPlayer==e?t:e},f.prototype.clickEvent=function(e){if(this.nEmpty===0)return 0;if(this.squares[e]!=n)return 0;this.userPlay(e);if(this.checkForVictoryCondition())return this.currentPlayer;if(this.checkForTieCondition())return"tie";if(this.mode=="two-player")this.changePlayer();else{this.aiPlay();if(this.checkForVictoryCondition())return t;if(this.checkForTieCondition())return"tie"}return"continue"},f.prototype.checkForVictoryCondition=function(){var t,r,i,s,o;for(i=0;i<a.plans.length;i++){t=r=0,o=a.plans[i];for(s=0;s<o.length;s++){if(o[s]==n)continue;if(this.squares[i]==n)break;this.squares[i]==e?t++:r++;if(t>0&&r>0)break;if(t==3||r==3)return!0}}return!1},f.prototype.checkForTieCondition=function(){return this.nEmpty===0},f.prototype.draw=function(){var e,t;t=this.grid.getElementsByTagName("div");for(e=0;e<this.squares.length;e++)t[e].innerHTML='<span class="cell-mark">'+this.squares[e]+"</span>"},a}),require(["2048","tic-tac-toe"],function(e,t){function o(e){var t,r=0;t=window.event||e;switch(t.keyCode){case 37:r=n.moveLeft();break;case 38:r=n.moveUp();break;case 39:r=n.moveRight();break;case 40:r=n.moveDown()}r&&n.draw()}var n,r,i,s=!1;i=document.getElementById("div_2048_grid"),n=e.newBoard(i,2048,2),r=t.newTicTacToeBoard(i),i.addEventListener("click",function(){s?(document.removeEventListener("keydown",o),s=!1):(document.addEventListener("keydown",o),s=!0,i.scrollIntoView(!0))}),document.getElementById("button_2048_reset").addEventListener("click",function(){n.reset(),n.draw(),i.scrollIntoView(!0)}),n.reset(),n.draw()}),define("main",function(){});